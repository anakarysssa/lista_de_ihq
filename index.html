<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ULAP — Lista IHQ</title>
  <style>
    body { font-family: system-ui, Arial; margin: 24px; background: #fafafa; }
    .card { max-width: 1180px; margin: 0 auto; padding: 16px; border: 1px solid #ddd; border-radius: 14px; background: #fff; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: end; }
    label { display: grid; gap: 6px; font-size: 13px; }
    input, textarea, select {
      padding: 10px; border: 1px solid #ccc; border-radius: 10px; min-width: 220px;
      font: inherit; background: #fff;
    }
    textarea { min-width: 460px; min-height: 42px; resize: vertical; }
    button {
      padding: 10px 14px; border: 1px solid #333; background: #111; color: #fff;
      border-radius: 10px; cursor: pointer;
    }
    button.secondary { background: #fff; color: #111; border-color: #bbb; }
    .muted { color: #666; font-size: 13px; }
    .hidden { display: none; }
    .right { margin-left: auto; }

    .toolbar { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; margin-top: 8px; }
    .toolbar input { min-width: 320px; }

    table { width: 100%; border-collapse: collapse; margin-top: 14px; }
    th, td { border-bottom: 1px solid #eee; padding: 10px; text-align: left; vertical-align: top; }
    th { position: sticky; top: 0; background: #fff; z-index: 1; }
    tr.done { background: #e9fbe9; }      /* já cadastrado */
    tr.pending { background: #fff; }      /* pendente */
    .tag { display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: 12px; border: 1px solid #ddd; }
    .tag.done { border-color: #86efac; }
    .tag.pending { border-color: #fde68a; }

    .w-120 { min-width: 120px; }
    .w-160 { min-width: 160px; }
    .w-200 { min-width: 200px; }
    .w-240 { min-width: 240px; }
    .w-300 { min-width: 300px; }
  </style>
</head>

<body>
  <!-- DEBUG PANEL (fica dentro do body) -->
  <pre id="debug" style="position:fixed;bottom:10px;left:10px;max-width:60vw;max-height:35vh;overflow:auto;background:#fff;border:1px solid #000;padding:8px;z-index:999999;font-size:12px;"></pre>

  <div class="card">
    <div class="row">
      <h2 style="margin: 0;">ULAP — Controle de Solicitações IHQ</h2>
      <button id="btnLogout" type="button" class="secondary right hidden">Sair</button>
    </div>
    <p class="muted" style="margin-top: 6px;">Login obrigatório. Hospedado no GitHub Pages + dados no Supabase.</p>

       <!-- LOGIN -->
<div id="authBox">
  <h3>Login</h3>
  <form id="loginForm" onsubmit="return false;">
    <div class="row">
      <label>E-mail
        <input id="email" type="email" placeholder="seu@email.com" required />
      </label>
      <label>Senha
        <input id="password" type="password" placeholder="••••••••" required />
      </label>
      <button id="btnLogin" type="submit">Entrar</button>
      <button id="btnSignup" type="button" class="secondary">Criar usuário</button>
    </div>
  </form>
  <p id="authMsg" class="muted"></p>
</div>

    <!-- APP -->
    <div id="appBox" class="hidden">
      <h3 style="margin: 12px 0 6px;">Novo registro</h3>

      <div class="row">
        <label class="w-200">Data de entrada na ULAP
          <input id="data_entrada_ulap" type="date" />
        </label>

        <label class="w-240">Número histopatológico
          <input id="numero_histopatologico" type="text" placeholder="Ex: H-2026-000123" />
        </label>

        <label class="w-300">Paciente
          <input id="paciente" type="text" placeholder="Nome completo" />
        </label>

        <label class="w-200">Matrícula Nº
          <input id="matricula_numero" type="text" placeholder="Ex: 123456" />
        </label>

        <label class="w-200">Data da solicitação
          <input id="data_solicitacao" type="date" />
        </label>

        <label class="w-300">Médico patologista
          <input id="medico_patologista" type="text" placeholder="Nome do patologista" />
        </label>

        <label class="w-300">Painel Anticorpos
          <textarea id="painel_anticorpos" placeholder="Ex: CK7, CK20, CDX2, HER2..."></textarea>
        </label>

        <label class="w-240">Número da Imuno-histoquímica
          <input id="numero_ihq" type="text" placeholder="Ex: IHQ-2026-00123" />
        </label>

        <label class="w-160">Já cadastrado?
          <select id="ja_cadastrado">
            <option value="false" selected>Não</option>
            <option value="true">Sim</option>
          </select>
        </label>

        <button id="btnAdd" type="button">Adicionar</button>
      </div>

      <div class="toolbar">
        <input id="search" type="text" placeholder="Buscar por paciente / histopatológico / matrícula / IHQ / patologista..." />
        <select id="filterStatus">
          <option value="all" selected>Todos</option>
          <option value="pending">Pendentes</option>
          <option value="done">Já cadastrados</option>
        </select>
        <button id="btnRefresh" type="button" class="secondary">Atualizar</button>
        <span id="appMsg" class="muted"></span>
      </div>

      <div style="overflow:auto; border:1px solid #eee; border-radius: 12px; margin-top: 10px;">
        <table>
          <thead>
            <tr>
              <th class="w-120">Status</th>
              <th class="w-200">Entrada ULAP</th>
              <th class="w-200">Solicitação</th>
              <th class="w-240">Histopatológico</th>
              <th class="w-300">Paciente</th>
              <th class="w-200">Matrícula</th>
              <th class="w-300">Patologista</th>
              <th class="w-300">Painel</th>
              <th class="w-240">Nº IHQ</th>
              <th class="w-160">Ações</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Versão -->
  <div style="position:fixed;bottom:10px;right:10px;background:#ff0;padding:6px 10px;border:1px solid #000;z-index:99999">
    VERSÃO 003 (debug auth)
  </div>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
   // CONFIG (ATENÇÃO: troque a key pela ANON PUBLIC KEY que começa com 'eyJ...')
const SUPABASE_URL = "https://guahceakslkppogyzlbd.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd1YWhjZWFrc2xrcHBvZ3l6bGJkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2Mzg0NjAsImV4cCI6MjA4MzIxNDQ2MH0.LwmRtZKO7vG_LPuyANt4hUjtFElxH5IsNieZcRkFn_g";

// Verifica se já existe uma instância do Supabase para evitar duplicação
let supabase;
if (window.supabaseClientInstance) {
  supabase = window.supabaseClientInstance;
  logDbg("DEBUG: usando cliente supabase existente ✅");
} else {
  try {
    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    window.supabaseClientInstance = supabase; // Armazena globalmente
    logDbg("DEBUG: supabase client criado ✅");
  } catch (e) {
    logDbg("DEBUG: falha criando supabase client ❌", e?.message || String(e));
  }
}

// UI refs
const authBox = document.getElementById("authBox");
const appBox = document.getElementById("appBox");
const authMsg = document.getElementById("authMsg");
const appMsg  = document.getElementById("appMsg");
const tbody   = document.getElementById("tbody");

const btnLogout = document.getElementById("btnLogout");
const email = document.getElementById("email");
const password = document.getElementById("password");

const f_data_entrada_ulap = document.getElementById("data_entrada_ulap");
const f_numero_histopatologico = document.getElementById("numero_histopatologico");
const f_paciente = document.getElementById("paciente");
const f_matricula_numero = document.getElementById("matricula_numero");
const f_data_solicitacao = document.getElementById("data_solicitacao");
const f_painel_anticorpos = document.getElementById("painel_anticorpos");
const f_medico_patologista = document.getElementById("medico_patologista");
const f_ja_cadastrado = document.getElementById("ja_cadastrado");
const f_numero_ihq = document.getElementById("numero_ihq");

const search = document.getElementById("search");
const filterStatus = document.getElementById("filterStatus");

let cache = [];

function toISODate(value) { return value ? value : null; }

function escapeHtml(str) {
  return String(str ?? "")
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}

function applyFiltersAndRender() {
  const q = search.value.trim().toLowerCase();
  const status = filterStatus.value;

  const filtered = cache.filter(r => {
    const hay = [
      r.paciente, r.numero_histopatologico, r.matricula_numero,
      r.numero_ihq, r.medico_patologista, r.painel_anticorpos
    ].join(" ").toLowerCase();

    const matchQ = !q || hay.includes(q);
    const matchStatus =
      status === "all" ||
      (status === "done" && r.ja_cadastrado) ||
      (status === "pending" && !r.ja_cadastrado);

    return matchQ && matchStatus;
  });

  renderTable(filtered);
}

function renderTable(rows) {
  tbody.innerHTML = "";
  for (const r of rows) {
    const tr = document.createElement("tr");
    tr.className = r.ja_cadastrado ? "done" : "pending";

    const tag = r.ja_cadastrado
      ? `<span class="tag done">Cadastrado</span>`
      : `<span class="tag pending">Pendente</span>`;

    tr.innerHTML = `
      <td>
        ${tag}<br/>
        <label style="display:flex; gap:8px; align-items:center; margin-top:8px;">
          <input type="checkbox" ${r.ja_cadastrado ? "checked" : ""} data-id="${r.id}" />
          <span class="muted">marcar</span>
        </label>
      </td>
      <td>${escapeHtml(r.data_entrada_ulap ?? "")}</td>
      <td>${escapeHtml(r.data_solicitacao ?? "")}</td>
      <td><b>${escapeHtml(r.numero_histopatologico)}</b></td>
      <td>${escapeHtml(r.paciente)}</td>
      <td>${escapeHtml(r.matricula_numero ?? "")}</td>
      <td>${escapeHtml(r.medico_patologista ?? "")}</td>
      <td>${escapeHtml(r.painel_anticorpos ?? "")}</td>
      <td>${escapeHtml(r.numero_ihq ?? "")}</td>
      <td>
        <button type="button" class="secondary" data-del="${r.id}">Excluir</button>
      </td>
    `;

    tr.querySelector('input[type="checkbox"]').addEventListener("change", async (ev) => {
      const id = Number(ev.target.getAttribute("data-id"));
      const ja_cadastrado = ev.target.checked;
      await updateStatus(id, ja_cadastrado);

      const idx = cache.findIndex(x => x.id === id);
      if (idx >= 0) cache[idx].ja_cadastrado = ja_cadastrado;

      applyFiltersAndRender();
    });

    tr.querySelector('button[data-del]').addEventListener("click", async (ev) => {
      const id = Number(ev.target.getAttribute("data-del"));
      if (!confirm("Excluir este registro?")) return;
      await deleteRegistro(id);
      cache = cache.filter(x => x.id !== id);
      applyFiltersAndRender();
    });

    tbody.appendChild(tr);
  }
}

async function setUIForSession() {
  if (!supabase) {
    logDbg("DEBUG: supabase não está definido!");
    return;
  }
  
  const { data: { session }, error } = await supabase.auth.getSession();
  logDbg("DEBUG: getSession", { hasSession: !!session, error: error?.message });

  const logged = !!session;
  authBox.classList.toggle("hidden", logged);
  appBox.classList.toggle("hidden", !logged);
  btnLogout.classList.toggle("hidden", !logged);

  if (logged) await loadRegistros();
  else { cache = []; tbody.innerHTML = ""; }
}

async function signup() {
  if (!supabase) {
    authMsg.textContent = "Erro: Cliente Supabase não inicializado";
    return;
  }
  
  authMsg.textContent = "Criando usuário...";
  logDbg("DEBUG: signup start", email.value.trim());

  const { error } = await supabase.auth.signUp({
    email: email.value.trim(),
    password: password.value
  });

  if (error) {
    authMsg.textContent = "Erro: " + error.message;
    logDbg("DEBUG: signup error", error.message);
    alert("Erro no cadastro: " + error.message);
    return;
  }

  authMsg.textContent = "Usuário criado. Tente entrar.";
  logDbg("DEBUG: signup ok ✅");
}

async function login() {
  if (!supabase) {
    authMsg.textContent = "Erro: Cliente Supabase não inicializado";
    return;
  }
  
  const e = email.value.trim();
  authMsg.textContent = "Entrando...";
  logDbg("DEBUG: login click ✅", e);

  const { data, error } = await supabase.auth.signInWithPassword({
    email: e,
    password: password.value
  });

  logDbg("DEBUG: signIn retorno", { ok: !error, error: error?.message });

  if (error) {
    authMsg.textContent = "Erro: " + error.message;
    alert("Erro no login: " + error.message);
    return;
  }

  authMsg.textContent = "Login OK ✅";
  await setUIForSession();
}

async function logout() {
  if (!supabase) return;
  await supabase.auth.signOut();
  logDbg("DEBUG: logout ✅");
  await setUIForSession();
}

async function addRegistro() {
  if (!supabase) {
    appMsg.textContent = "Erro: Cliente Supabase não inicializado";
    return;
  }
  
  const payload = {
    data_entrada_ulap: toISODate(f_data_entrada_ulap.value),
    numero_histopatologico: f_numero_histopatologico.value.trim(),
    paciente: f_paciente.value.trim(),
    matricula_numero: f_matricula_numero.value.trim() || null,
    data_solicitacao: toISODate(f_data_solicitacao.value),
    painel_anticorpos: f_painel_anticorpos.value.trim() || null,
    medico_patologista: f_medico_patologista.value.trim() || null,
    ja_cadastrado: (f_ja_cadastrado.value === "true"),
    numero_ihq: f_numero_ihq.value.trim() || null
  };

  if (!payload.numero_histopatologico) { appMsg.textContent = "Informe o Número histopatológico."; return; }
  if (!payload.paciente) { appMsg.textContent = "Informe o Paciente."; return; }

  appMsg.textContent = "Salvando...";
  const { error } = await supabase.from("ulap_ihq").insert(payload);
  if (error) { appMsg.textContent = "Erro ao adicionar: " + error.message; return; }

  f_data_entrada_ulap.value = "";
  f_numero_histopatologico.value = "";
  f_paciente.value = "";
  f_matricula_numero.value = "";
  f_data_solicitacao.value = "";
  f_painel_anticorpos.value = "";
  f_medico_patologista.value = "";
  f_ja_cadastrado.value = "false";
  f_numero_ihq.value = "";

  appMsg.textContent = "";
  await loadRegistros();
}

async function updateStatus(id, ja_cadastrado) {
  if (!supabase) return;
  const { error } = await supabase
    .from("ulap_ihq")
    .update({ ja_cadastrado })
    .eq("id", id);

  if (error) appMsg.textContent = "Erro ao atualizar status: " + error.message;
  else appMsg.textContent = "";
}

async function deleteRegistro(id) {
  if (!supabase) return;
  const { error } = await supabase.from("ulap_ihq").delete().eq("id", id);
  if (error) appMsg.textContent = "Erro ao excluir: " + error.message;
  else appMsg.textContent = "";
}

async function loadRegistros() {
  if (!supabase) {
    appMsg.textContent = "Erro: Cliente Supabase não inicializado";
    return;
  }
  
  appMsg.textContent = "Carregando...";
  const { data, error } = await supabase
    .from("ulap_ihq")
    .select("id, data_entrada_ulap, numero_histopatologico, paciente, matricula_numero, data_solicitacao, painel_anticorpos, medico_patologista, ja_cadastrado, numero_ihq, created_at")
    .order("created_at", { ascending: false });

  if (error) { appMsg.textContent = "Erro ao carregar: " + error.message; return; }

  cache = data ?? [];
  appMsg.textContent = cache.length ? "" : "Sem registros ainda.";
  applyFiltersAndRender();
}

// Bind events (sem depender de ordem de script)
document.addEventListener("DOMContentLoaded", () => {
  logDbg("DEBUG: DOMContentLoaded ✅");

  document.getElementById("btnLogin").addEventListener("click", login);
  document.getElementById("btnSignup").addEventListener("click", signup);
  document.getElementById("btnLogout").addEventListener("click", logout);
  document.getElementById("btnAdd").addEventListener("click", addRegistro);
  document.getElementById("btnRefresh").addEventListener("click", loadRegistros);

  search.addEventListener("input", applyFiltersAndRender);
  filterStatus.addEventListener("change", applyFiltersAndRender);

  if (supabase) {
    supabase.auth.onAuthStateChange(() => setUIForSession());
    setUIForSession();
  } else {
    logDbg("DEBUG: supabase não disponível para onAuthStateChange");
  }
});




